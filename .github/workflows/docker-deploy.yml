name: ğŸ”” NotificaÃ§Ã£o de Commits

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  notify-commit:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ“Š InformaÃ§Ãµes do Commit
      run: |
        echo "## ğŸ”” Novo Commit Detectado!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ”– Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸŒ¿ Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ‘¤ Autor:** \`${{ github.actor }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ“… Data:** \`$(date)\`" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ’¬ Mensagem:** \`${{ github.event.head_commit.message }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸš€ Deploy Local:" >> $GITHUB_STEP_SUMMARY
        echo "- O sistema de automaÃ§Ã£o local detectarÃ¡ este commit" >> $GITHUB_STEP_SUMMARY
        echo "- O build serÃ¡ feito localmente (sem Docker Hub)" >> $GITHUB_STEP_SUMMARY
        echo "- A aplicaÃ§Ã£o serÃ¡ atualizada automaticamente" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ VerificaÃ§Ãµes:" >> $GITHUB_STEP_SUMMARY
        echo "1. âœ… Webhook/Monitor local ativo" >> $GITHUB_STEP_SUMMARY
        echo "2. âœ… Docker funcionando localmente" >> $GITHUB_STEP_SUMMARY
        echo "3. âœ… AplicaÃ§Ã£o em http://localhost:5000" >> $GITHUB_STEP_SUMMARY

  validate-structure:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ” Validar Estrutura do Projeto
      run: |
        echo "Validando estrutura do projeto..."
        
        # Verificar arquivos essenciais
        if [ ! -f "Dockerfile" ]; then
          echo "âŒ Dockerfile nÃ£o encontrado!"
          exit 1
        fi
        
        if [ ! -f "docker-compose.yml" ]; then
          echo "âŒ docker-compose.yml nÃ£o encontrado!"
          exit 1
        fi
        
        if [ ! -f "requirements.txt" ]; then
          echo "âŒ requirements.txt nÃ£o encontrado!"
          exit 1
        fi
        
        if [ ! -d "src" ]; then
          echo "âŒ DiretÃ³rio src nÃ£o encontrado!"
          exit 1
        fi
        
        echo "âœ… Estrutura do projeto validada com sucesso!"
        
    - name: ğŸ“¦ Verificar DependÃªncias Python
      run: |
        echo "Verificando requirements.txt..."
        if [ -f "requirements.txt" ]; then
          echo "ğŸ“‹ DependÃªncias encontradas:"
          cat requirements.txt
        fi
        
        if [ -f "requirements-automation.txt" ]; then
          echo "ğŸ¤– DependÃªncias de automaÃ§Ã£o:"
          cat requirements-automation.txt
        fi

  notify-local-systems:
    needs: [notify-commit, validate-structure]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“¢ Status Final
      run: |
        echo "## ğŸ“Š Resumo do Pipeline"
        echo ""
        if [ "${{ needs.notify-commit.result }}" == "success" ]; then
          echo "âœ… NotificaÃ§Ã£o de commit: Sucesso"
        else
          echo "âŒ NotificaÃ§Ã£o de commit: Falha"
        fi
        
        if [ "${{ needs.validate-structure.result }}" == "success" ]; then
          echo "âœ… ValidaÃ§Ã£o de estrutura: Sucesso"
        else
          echo "âŒ ValidaÃ§Ã£o de estrutura: Falha"
        fi
        
        echo ""
        echo "ğŸ  **Deploy Local AutomÃ¡tico:**"
        echo "- Monitor local detectarÃ¡ este commit"
        echo "- Build serÃ¡ executado localmente"
        echo "- Sem necessidade de Docker Hub"
        echo "- AplicaÃ§Ã£o serÃ¡ reiniciada automaticamente"